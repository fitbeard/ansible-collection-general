---
- import_tasks: cleanup.yml
  when: systemd_networkd_cleanup | bool

- import_tasks: config.yml

- name: Disable NetworkManager service
  service:
    name: NetworkManager
    state: stopped
    enabled: false
  ignore_errors: true

- name: Disable network service
  service:
    name: network
    state: stopped
    enabled: false
  ignore_errors: true

- name: Install systemd-networkd package
  package:
    name: systemd-networkd

- name: Enable systemd-networkd
  service:
    name: systemd-networkd
    enabled: yes
  when: systemd_networkd_network is defined or systemd_networkd_link is defined or systemd_networkd_netdev is defined

- name: Start and enable systemd-resolved
  service:
    name: systemd-resolved
    enabled: yes
    state: started
  when: systemd_networkd_enable_resolved | bool

- name: Replace /etc/resolv.conf with a symlink to the systemd-resolved {{ systemd_networkd_resolv_conf }}
  become: true
  file:
    path: /etc/resolv.conf
    src: "/run/systemd/resolve/{{ systemd_networkd_resolv_conf }}"
    state: link
    force: yes
  when: systemd_networkd_symlink_resolv_conf | bool

- name: Flush handlers
  meta: flush_handlers
